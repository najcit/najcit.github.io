---
title: 如何做到高可用、高并发、高性能
published: true
categories: [algorithm]
---

## 高性能
对于给定的计算任务，程序完成它所需消耗的 CPU 时钟周期数越少，性能就越高；反之，性能就越低。

### 时钟周期
*时钟周期*也称为振荡周期，定义为时钟频率的倒数。
时钟周期是计算机中最基本的、最小的时间单位。
时钟周期是一个时间的量。
在一个时钟周期内，CPU 仅完成一个最基本的动作。

### 高性能系统优化方向
#### 架构领域(几何级)
    * 拆解业务并行运行
    * 选择合适的数据结构与算法
#### 编码领域(数量级)
    * 选择和设计性能较好的基础库，如线程池、连接池、IO多路复用库
    * 复用基础库，消除重复代码
#### 硬件领域(倍数级)
    * 结合程序运行的硬件环境，优化部分代码
    * 充分利用硬件资源，如内存，多核 CPU

### 常见代码优化方式
1. 提前计算好经常使用到固定的变量
2. 使用缓存，且尽量提高访存效率
3. 用汇编代码实现关键例程
4. 绑定 CPU ，排除系统干扰，减少中断

## 高并发
高并发是系统架构设计中必须考虑的因素之一，它通常是指通过设计保证系统能够同时并行处理很多请求。

### 高并发指标
*吞吐量*：单位时间内处理的请求数量。  
*响应时间*：系统对请求做出响应的时间。  
*QPS*：每秒响应请求数。  
*TPS*：每秒响应事务数。  
*并发数*：同时承载正常使用系统功能的用户数量。

QPS(TPS) = 并发数 / 平均响应时间

吞吐量通常有 QPS(TPS) ，并发数两个因素决定，每套系统这个两个值都有一个相对极限值，在应用场景访问压力下，只要某一项达到系统最高值，系统吞吐量就上不去了，如果压力继续增大，系统的吞吐量反而会下降，原因是系统超负荷工作，上下文切换，内存等等其他消耗导致系统性能下降。

### 如何提高系统的并发能力
#### 垂直扩展
    * 增强单机硬件性能，例如：增加CPU核数如32核，升级更好的网卡如万兆，升级更好的硬盘如SSD，扩充硬盘容量如2T，扩充系统内存如128G；
    * 提升单机架构性能，例如：使用Cache来减少IO次数，使用异步来增加单服务吞吐量，使用无锁数据结构来减少响应时间；
#### 水平扩展
    * 增加服务器数量，就能线性扩充系统性能，但水平扩展对系统架构设计是有要求的。

### 如何在架构各层进行可水平扩展的设计
![互联网架构](/images/framework/system.png)

常见互联网分布式架构如上，分为：
1. 客户端层：典型调用方是浏览器或者手机应用
2. 反向代理层：系统入口，反向代理，负载均衡
3. 应用层：实现核心应用逻辑，返回页面
4. 服务层：微服务
5. 缓存层：缓存加速访问存储
6. 数据库层：数据库固化数据存储
除了客户端层以外，每层都可以水平扩展，实现性能提升。
反向代理层的水平扩展，是通过“DNS轮询”实现的：dns-server对于一个域名配置了多个解析ip，每次DNS解析请求来访问dns-server，会轮询返回这些ip。
应用层的水平扩展，通过负载均衡实现的。
服务层的水平扩展，是通过服务连接池实现的。
数据层（缓存，数据库）涉及数据的水平扩展，在数据量很大的情况下，将原本存储在一台服务器上的数据（缓存，数据库）水平拆分到不同服务器上去，以达到扩充系统性能的目的。常见的拆分按照 uuid 拆分，哈希拆分，读写拆分等方法分离数据。

## 高可用
高可用保证的原则是“集群化”，或者叫“冗余”：只有一个单点，挂了服务会受影响；如果有冗余备份，挂了还有其他备份能够顶上。
保证系统高可用，架构设计的核心准则是：冗余。
有了冗余之后，还不够，每次出现故障需要人工介入恢复势必会增加系统的不可服务实践。所以，又往往是通过“自动故障转移”来实现系统的高可用。
接下来我们看下典型互联网架构中，如何通过*冗余+自动故障转移*来保证系统的高可用特性。